<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<style type="text/css">
pre { white-space: pre-wrap; }
.ef0,.f0 { color: #000000; } .eb0,.b0 { background-color: #000000; }
.ef1,.f1 { color: #AA0000; } .eb1,.b1 { background-color: #AA0000; }
.ef2,.f2 { color: #00AA00; } .eb2,.b2 { background-color: #00AA00; }
.ef3,.f3 { color: #AA5500; } .eb3,.b3 { background-color: #AA5500; }
.ef4,.f4 { color: #0000AA; } .eb4,.b4 { background-color: #0000AA; }
.ef5,.f5 { color: #AA00AA; } .eb5,.b5 { background-color: #AA00AA; }
.ef6,.f6 { color: #00AAAA; } .eb6,.b6 { background-color: #00AAAA; }
.ef7,.f7 { color: #AAAAAA; } .eb7,.b7 { background-color: #AAAAAA; }
.ef8, .f0 > .bold,.bold > .f0 { color: #555555; font-weight: normal; }
.ef9, .f1 > .bold,.bold > .f1 { color: #FF5555; font-weight: normal; }
.ef10,.f2 > .bold,.bold > .f2 { color: #55FF55; font-weight: normal; }
.ef11,.f3 > .bold,.bold > .f3 { color: #FFFF55; font-weight: normal; }
.ef12,.f4 > .bold,.bold > .f4 { color: #5555FF; font-weight: normal; }
.ef13,.f5 > .bold,.bold > .f5 { color: #FF55FF; font-weight: normal; }
.ef14,.f6 > .bold,.bold > .f6 { color: #55FFFF; font-weight: normal; }
.ef15,.f7 > .bold,.bold > .f7 { color: #FFFFFF; font-weight: normal; }
.eb8  { background-color: #555555; }
.eb9  { background-color: #FF5555; }
.eb10 { background-color: #55FF55; }
.eb11 { background-color: #FFFF55; }
.eb12 { background-color: #5555FF; }
.eb13 { background-color: #FF55FF; }
.eb14 { background-color: #55FFFF; }
.eb15 { background-color: #FFFFFF; }
.ef16 { color: #000000; } .eb16 { background-color: #000000; }
.ef17 { color: #00005f; } .eb17 { background-color: #00005f; }
.ef18 { color: #000087; } .eb18 { background-color: #000087; }
.ef19 { color: #0000af; } .eb19 { background-color: #0000af; }
.ef20 { color: #0000d7; } .eb20 { background-color: #0000d7; }
.ef21 { color: #0000ff; } .eb21 { background-color: #0000ff; }
.ef22 { color: #005f00; } .eb22 { background-color: #005f00; }
.ef23 { color: #005f5f; } .eb23 { background-color: #005f5f; }
.ef24 { color: #005f87; } .eb24 { background-color: #005f87; }
.ef25 { color: #005faf; } .eb25 { background-color: #005faf; }
.ef26 { color: #005fd7; } .eb26 { background-color: #005fd7; }
.ef27 { color: #005fff; } .eb27 { background-color: #005fff; }
.ef28 { color: #008700; } .eb28 { background-color: #008700; }
.ef29 { color: #00875f; } .eb29 { background-color: #00875f; }
.ef30 { color: #008787; } .eb30 { background-color: #008787; }
.ef31 { color: #0087af; } .eb31 { background-color: #0087af; }
.ef32 { color: #0087d7; } .eb32 { background-color: #0087d7; }
.ef33 { color: #0087ff; } .eb33 { background-color: #0087ff; }
.ef34 { color: #00af00; } .eb34 { background-color: #00af00; }
.ef35 { color: #00af5f; } .eb35 { background-color: #00af5f; }
.ef36 { color: #00af87; } .eb36 { background-color: #00af87; }
.ef37 { color: #00afaf; } .eb37 { background-color: #00afaf; }
.ef38 { color: #00afd7; } .eb38 { background-color: #00afd7; }
.ef39 { color: #00afff; } .eb39 { background-color: #00afff; }
.ef40 { color: #00d700; } .eb40 { background-color: #00d700; }
.ef41 { color: #00d75f; } .eb41 { background-color: #00d75f; }
.ef42 { color: #00d787; } .eb42 { background-color: #00d787; }
.ef43 { color: #00d7af; } .eb43 { background-color: #00d7af; }
.ef44 { color: #00d7d7; } .eb44 { background-color: #00d7d7; }
.ef45 { color: #00d7ff; } .eb45 { background-color: #00d7ff; }
.ef46 { color: #00ff00; } .eb46 { background-color: #00ff00; }
.ef47 { color: #00ff5f; } .eb47 { background-color: #00ff5f; }
.ef48 { color: #00ff87; } .eb48 { background-color: #00ff87; }
.ef49 { color: #00ffaf; } .eb49 { background-color: #00ffaf; }
.ef50 { color: #00ffd7; } .eb50 { background-color: #00ffd7; }
.ef51 { color: #00ffff; } .eb51 { background-color: #00ffff; }
.ef52 { color: #5f0000; } .eb52 { background-color: #5f0000; }
.ef53 { color: #5f005f; } .eb53 { background-color: #5f005f; }
.ef54 { color: #5f0087; } .eb54 { background-color: #5f0087; }
.ef55 { color: #5f00af; } .eb55 { background-color: #5f00af; }
.ef56 { color: #5f00d7; } .eb56 { background-color: #5f00d7; }
.ef57 { color: #5f00ff; } .eb57 { background-color: #5f00ff; }
.ef58 { color: #5f5f00; } .eb58 { background-color: #5f5f00; }
.ef59 { color: #5f5f5f; } .eb59 { background-color: #5f5f5f; }
.ef60 { color: #5f5f87; } .eb60 { background-color: #5f5f87; }
.ef61 { color: #5f5faf; } .eb61 { background-color: #5f5faf; }
.ef62 { color: #5f5fd7; } .eb62 { background-color: #5f5fd7; }
.ef63 { color: #5f5fff; } .eb63 { background-color: #5f5fff; }
.ef64 { color: #5f8700; } .eb64 { background-color: #5f8700; }
.ef65 { color: #5f875f; } .eb65 { background-color: #5f875f; }
.ef66 { color: #5f8787; } .eb66 { background-color: #5f8787; }
.ef67 { color: #5f87af; } .eb67 { background-color: #5f87af; }
.ef68 { color: #5f87d7; } .eb68 { background-color: #5f87d7; }
.ef69 { color: #5f87ff; } .eb69 { background-color: #5f87ff; }
.ef70 { color: #5faf00; } .eb70 { background-color: #5faf00; }
.ef71 { color: #5faf5f; } .eb71 { background-color: #5faf5f; }
.ef72 { color: #5faf87; } .eb72 { background-color: #5faf87; }
.ef73 { color: #5fafaf; } .eb73 { background-color: #5fafaf; }
.ef74 { color: #5fafd7; } .eb74 { background-color: #5fafd7; }
.ef75 { color: #5fafff; } .eb75 { background-color: #5fafff; }
.ef76 { color: #5fd700; } .eb76 { background-color: #5fd700; }
.ef77 { color: #5fd75f; } .eb77 { background-color: #5fd75f; }
.ef78 { color: #5fd787; } .eb78 { background-color: #5fd787; }
.ef79 { color: #5fd7af; } .eb79 { background-color: #5fd7af; }
.ef80 { color: #5fd7d7; } .eb80 { background-color: #5fd7d7; }
.ef81 { color: #5fd7ff; } .eb81 { background-color: #5fd7ff; }
.ef82 { color: #5fff00; } .eb82 { background-color: #5fff00; }
.ef83 { color: #5fff5f; } .eb83 { background-color: #5fff5f; }
.ef84 { color: #5fff87; } .eb84 { background-color: #5fff87; }
.ef85 { color: #5fffaf; } .eb85 { background-color: #5fffaf; }
.ef86 { color: #5fffd7; } .eb86 { background-color: #5fffd7; }
.ef87 { color: #5fffff; } .eb87 { background-color: #5fffff; }
.ef88 { color: #870000; } .eb88 { background-color: #870000; }
.ef89 { color: #87005f; } .eb89 { background-color: #87005f; }
.ef90 { color: #870087; } .eb90 { background-color: #870087; }
.ef91 { color: #8700af; } .eb91 { background-color: #8700af; }
.ef92 { color: #8700d7; } .eb92 { background-color: #8700d7; }
.ef93 { color: #8700ff; } .eb93 { background-color: #8700ff; }
.ef94 { color: #875f00; } .eb94 { background-color: #875f00; }
.ef95 { color: #875f5f; } .eb95 { background-color: #875f5f; }
.ef96 { color: #875f87; } .eb96 { background-color: #875f87; }
.ef97 { color: #875faf; } .eb97 { background-color: #875faf; }
.ef98 { color: #875fd7; } .eb98 { background-color: #875fd7; }
.ef99 { color: #875fff; } .eb99 { background-color: #875fff; }
.ef100 { color: #878700; } .eb100 { background-color: #878700; }
.ef101 { color: #87875f; } .eb101 { background-color: #87875f; }
.ef102 { color: #878787; } .eb102 { background-color: #878787; }
.ef103 { color: #8787af; } .eb103 { background-color: #8787af; }
.ef104 { color: #8787d7; } .eb104 { background-color: #8787d7; }
.ef105 { color: #8787ff; } .eb105 { background-color: #8787ff; }
.ef106 { color: #87af00; } .eb106 { background-color: #87af00; }
.ef107 { color: #87af5f; } .eb107 { background-color: #87af5f; }
.ef108 { color: #87af87; } .eb108 { background-color: #87af87; }
.ef109 { color: #87afaf; } .eb109 { background-color: #87afaf; }
.ef110 { color: #87afd7; } .eb110 { background-color: #87afd7; }
.ef111 { color: #87afff; } .eb111 { background-color: #87afff; }
.ef112 { color: #87d700; } .eb112 { background-color: #87d700; }
.ef113 { color: #87d75f; } .eb113 { background-color: #87d75f; }
.ef114 { color: #87d787; } .eb114 { background-color: #87d787; }
.ef115 { color: #87d7af; } .eb115 { background-color: #87d7af; }
.ef116 { color: #87d7d7; } .eb116 { background-color: #87d7d7; }
.ef117 { color: #87d7ff; } .eb117 { background-color: #87d7ff; }
.ef118 { color: #87ff00; } .eb118 { background-color: #87ff00; }
.ef119 { color: #87ff5f; } .eb119 { background-color: #87ff5f; }
.ef120 { color: #87ff87; } .eb120 { background-color: #87ff87; }
.ef121 { color: #87ffaf; } .eb121 { background-color: #87ffaf; }
.ef122 { color: #87ffd7; } .eb122 { background-color: #87ffd7; }
.ef123 { color: #87ffff; } .eb123 { background-color: #87ffff; }
.ef124 { color: #af0000; } .eb124 { background-color: #af0000; }
.ef125 { color: #af005f; } .eb125 { background-color: #af005f; }
.ef126 { color: #af0087; } .eb126 { background-color: #af0087; }
.ef127 { color: #af00af; } .eb127 { background-color: #af00af; }
.ef128 { color: #af00d7; } .eb128 { background-color: #af00d7; }
.ef129 { color: #af00ff; } .eb129 { background-color: #af00ff; }
.ef130 { color: #af5f00; } .eb130 { background-color: #af5f00; }
.ef131 { color: #af5f5f; } .eb131 { background-color: #af5f5f; }
.ef132 { color: #af5f87; } .eb132 { background-color: #af5f87; }
.ef133 { color: #af5faf; } .eb133 { background-color: #af5faf; }
.ef134 { color: #af5fd7; } .eb134 { background-color: #af5fd7; }
.ef135 { color: #af5fff; } .eb135 { background-color: #af5fff; }
.ef136 { color: #af8700; } .eb136 { background-color: #af8700; }
.ef137 { color: #af875f; } .eb137 { background-color: #af875f; }
.ef138 { color: #af8787; } .eb138 { background-color: #af8787; }
.ef139 { color: #af87af; } .eb139 { background-color: #af87af; }
.ef140 { color: #af87d7; } .eb140 { background-color: #af87d7; }
.ef141 { color: #af87ff; } .eb141 { background-color: #af87ff; }
.ef142 { color: #afaf00; } .eb142 { background-color: #afaf00; }
.ef143 { color: #afaf5f; } .eb143 { background-color: #afaf5f; }
.ef144 { color: #afaf87; } .eb144 { background-color: #afaf87; }
.ef145 { color: #afafaf; } .eb145 { background-color: #afafaf; }
.ef146 { color: #afafd7; } .eb146 { background-color: #afafd7; }
.ef147 { color: #afafff; } .eb147 { background-color: #afafff; }
.ef148 { color: #afd700; } .eb148 { background-color: #afd700; }
.ef149 { color: #afd75f; } .eb149 { background-color: #afd75f; }
.ef150 { color: #afd787; } .eb150 { background-color: #afd787; }
.ef151 { color: #afd7af; } .eb151 { background-color: #afd7af; }
.ef152 { color: #afd7d7; } .eb152 { background-color: #afd7d7; }
.ef153 { color: #afd7ff; } .eb153 { background-color: #afd7ff; }
.ef154 { color: #afff00; } .eb154 { background-color: #afff00; }
.ef155 { color: #afff5f; } .eb155 { background-color: #afff5f; }
.ef156 { color: #afff87; } .eb156 { background-color: #afff87; }
.ef157 { color: #afffaf; } .eb157 { background-color: #afffaf; }
.ef158 { color: #afffd7; } .eb158 { background-color: #afffd7; }
.ef159 { color: #afffff; } .eb159 { background-color: #afffff; }
.ef160 { color: #d70000; } .eb160 { background-color: #d70000; }
.ef161 { color: #d7005f; } .eb161 { background-color: #d7005f; }
.ef162 { color: #d70087; } .eb162 { background-color: #d70087; }
.ef163 { color: #d700af; } .eb163 { background-color: #d700af; }
.ef164 { color: #d700d7; } .eb164 { background-color: #d700d7; }
.ef165 { color: #d700ff; } .eb165 { background-color: #d700ff; }
.ef166 { color: #d75f00; } .eb166 { background-color: #d75f00; }
.ef167 { color: #d75f5f; } .eb167 { background-color: #d75f5f; }
.ef168 { color: #d75f87; } .eb168 { background-color: #d75f87; }
.ef169 { color: #d75faf; } .eb169 { background-color: #d75faf; }
.ef170 { color: #d75fd7; } .eb170 { background-color: #d75fd7; }
.ef171 { color: #d75fff; } .eb171 { background-color: #d75fff; }
.ef172 { color: #d78700; } .eb172 { background-color: #d78700; }
.ef173 { color: #d7875f; } .eb173 { background-color: #d7875f; }
.ef174 { color: #d78787; } .eb174 { background-color: #d78787; }
.ef175 { color: #d787af; } .eb175 { background-color: #d787af; }
.ef176 { color: #d787d7; } .eb176 { background-color: #d787d7; }
.ef177 { color: #d787ff; } .eb177 { background-color: #d787ff; }
.ef178 { color: #d7af00; } .eb178 { background-color: #d7af00; }
.ef179 { color: #d7af5f; } .eb179 { background-color: #d7af5f; }
.ef180 { color: #d7af87; } .eb180 { background-color: #d7af87; }
.ef181 { color: #d7afaf; } .eb181 { background-color: #d7afaf; }
.ef182 { color: #d7afd7; } .eb182 { background-color: #d7afd7; }
.ef183 { color: #d7afff; } .eb183 { background-color: #d7afff; }
.ef184 { color: #d7d700; } .eb184 { background-color: #d7d700; }
.ef185 { color: #d7d75f; } .eb185 { background-color: #d7d75f; }
.ef186 { color: #d7d787; } .eb186 { background-color: #d7d787; }
.ef187 { color: #d7d7af; } .eb187 { background-color: #d7d7af; }
.ef188 { color: #d7d7d7; } .eb188 { background-color: #d7d7d7; }
.ef189 { color: #d7d7ff; } .eb189 { background-color: #d7d7ff; }
.ef190 { color: #d7ff00; } .eb190 { background-color: #d7ff00; }
.ef191 { color: #d7ff5f; } .eb191 { background-color: #d7ff5f; }
.ef192 { color: #d7ff87; } .eb192 { background-color: #d7ff87; }
.ef193 { color: #d7ffaf; } .eb193 { background-color: #d7ffaf; }
.ef194 { color: #d7ffd7; } .eb194 { background-color: #d7ffd7; }
.ef195 { color: #d7ffff; } .eb195 { background-color: #d7ffff; }
.ef196 { color: #ff0000; } .eb196 { background-color: #ff0000; }
.ef197 { color: #ff005f; } .eb197 { background-color: #ff005f; }
.ef198 { color: #ff0087; } .eb198 { background-color: #ff0087; }
.ef199 { color: #ff00af; } .eb199 { background-color: #ff00af; }
.ef200 { color: #ff00d7; } .eb200 { background-color: #ff00d7; }
.ef201 { color: #ff00ff; } .eb201 { background-color: #ff00ff; }
.ef202 { color: #ff5f00; } .eb202 { background-color: #ff5f00; }
.ef203 { color: #ff5f5f; } .eb203 { background-color: #ff5f5f; }
.ef204 { color: #ff5f87; } .eb204 { background-color: #ff5f87; }
.ef205 { color: #ff5faf; } .eb205 { background-color: #ff5faf; }
.ef206 { color: #ff5fd7; } .eb206 { background-color: #ff5fd7; }
.ef207 { color: #ff5fff; } .eb207 { background-color: #ff5fff; }
.ef208 { color: #ff8700; } .eb208 { background-color: #ff8700; }
.ef209 { color: #ff875f; } .eb209 { background-color: #ff875f; }
.ef210 { color: #ff8787; } .eb210 { background-color: #ff8787; }
.ef211 { color: #ff87af; } .eb211 { background-color: #ff87af; }
.ef212 { color: #ff87d7; } .eb212 { background-color: #ff87d7; }
.ef213 { color: #ff87ff; } .eb213 { background-color: #ff87ff; }
.ef214 { color: #ffaf00; } .eb214 { background-color: #ffaf00; }
.ef215 { color: #ffaf5f; } .eb215 { background-color: #ffaf5f; }
.ef216 { color: #ffaf87; } .eb216 { background-color: #ffaf87; }
.ef217 { color: #ffafaf; } .eb217 { background-color: #ffafaf; }
.ef218 { color: #ffafd7; } .eb218 { background-color: #ffafd7; }
.ef219 { color: #ffafff; } .eb219 { background-color: #ffafff; }
.ef220 { color: #ffd700; } .eb220 { background-color: #ffd700; }
.ef221 { color: #ffd75f; } .eb221 { background-color: #ffd75f; }
.ef222 { color: #ffd787; } .eb222 { background-color: #ffd787; }
.ef223 { color: #ffd7af; } .eb223 { background-color: #ffd7af; }
.ef224 { color: #ffd7d7; } .eb224 { background-color: #ffd7d7; }
.ef225 { color: #ffd7ff; } .eb225 { background-color: #ffd7ff; }
.ef226 { color: #ffff00; } .eb226 { background-color: #ffff00; }
.ef227 { color: #ffff5f; } .eb227 { background-color: #ffff5f; }
.ef228 { color: #ffff87; } .eb228 { background-color: #ffff87; }
.ef229 { color: #ffffaf; } .eb229 { background-color: #ffffaf; }
.ef230 { color: #ffffd7; } .eb230 { background-color: #ffffd7; }
.ef231 { color: #ffffff; } .eb231 { background-color: #ffffff; }
.ef232 { color: #080808; } .eb232 { background-color: #080808; }
.ef233 { color: #121212; } .eb233 { background-color: #121212; }
.ef234 { color: #1c1c1c; } .eb234 { background-color: #1c1c1c; }
.ef235 { color: #262626; } .eb235 { background-color: #262626; }
.ef236 { color: #303030; } .eb236 { background-color: #303030; }
.ef237 { color: #3a3a3a; } .eb237 { background-color: #3a3a3a; }
.ef238 { color: #444444; } .eb238 { background-color: #444444; }
.ef239 { color: #4e4e4e; } .eb239 { background-color: #4e4e4e; }
.ef240 { color: #585858; } .eb240 { background-color: #585858; }
.ef241 { color: #626262; } .eb241 { background-color: #626262; }
.ef242 { color: #6c6c6c; } .eb242 { background-color: #6c6c6c; }
.ef243 { color: #767676; } .eb243 { background-color: #767676; }
.ef244 { color: #808080; } .eb244 { background-color: #808080; }
.ef245 { color: #8a8a8a; } .eb245 { background-color: #8a8a8a; }
.ef246 { color: #949494; } .eb246 { background-color: #949494; }
.ef247 { color: #9e9e9e; } .eb247 { background-color: #9e9e9e; }
.ef248 { color: #a8a8a8; } .eb248 { background-color: #a8a8a8; }
.ef249 { color: #b2b2b2; } .eb249 { background-color: #b2b2b2; }
.ef250 { color: #bcbcbc; } .eb250 { background-color: #bcbcbc; }
.ef251 { color: #c6c6c6; } .eb251 { background-color: #c6c6c6; }
.ef252 { color: #d0d0d0; } .eb252 { background-color: #d0d0d0; }
.ef253 { color: #dadada; } .eb253 { background-color: #dadada; }
.ef254 { color: #e4e4e4; } .eb254 { background-color: #e4e4e4; }
.ef255 { color: #eeeeee; } .eb255 { background-color: #eeeeee; }

.f9 { color: #000000; }
.b9 { background-color: #FFFFFF; }
.f9 > .bold,.bold > .f9, body.f9 > pre > .bold {
  /* Bold is heavy black on white, or bright white
     depending on the default background */
  color: #000000;
  font-weight: bold;
}
.reverse {
  /* CSS does not support swapping fg and bg colours unfortunately,
     so just hardcode something that will look OK on all backgrounds. */
  color: #000000; background-color: #AAAAAA;
}
.underline { text-decoration: underline; }
.line-through { text-decoration: line-through; }
.blink { text-decoration: blink; }

/* Avoid pixels between adjacent span elements.
   Note this only works for lines less than 80 chars
   where we close span elements on the same line.
span { display: inline-block; }
*/
</style>
</head>

<body class="f9 b9">
<pre>
<span class="bold">diff --git a/wallet/mixing.go b/wallet/mixing.go</span>
<span class="bold">index ae689008..3f507c06 100644</span>
<span class="bold">--- a/wallet/mixing.go</span>
<span class="bold">+++ b/wallet/mixing.go</span>
<span class="f6">@@ -6,81 +6,56 @@</span> package wallet
 
 import (
 	&quot;context&quot;
<span class="f1">-	&quot;sync/atomic&quot;</span>
<span class="f1">-</span>
<span class="f1">-	&quot;decred.org/dcrwallet/v5/errors&quot;</span>
<span class="f1">-	&quot;decred.org/dcrwallet/v5/wallet/txrules&quot;</span>
<span class="f1">-	&quot;decred.org/dcrwallet/v5/wallet/txsizes&quot;</span>
<span class="f1">-	&quot;decred.org/dcrwallet/v5/wallet/udb&quot;</span>
<span class="f1">-	&quot;decred.org/dcrwallet/v5/wallet/walletdb&quot;</span>
<span class="f1">-	&quot;github.com/decred/dcrd/chaincfg/chainhash&quot;</span>
<span class="f1">-	&quot;github.com/decred/dcrd/chaincfg/v3&quot;</span>
<span class="f1">-	&quot;github.com/decred/dcrd/dcrec&quot;</span>
<span class="f1">-	&quot;github.com/decred/dcrd/dcrec/secp256k1/v4&quot;</span>
<span class="f1">-	&quot;github.com/decred/dcrd/dcrutil/v4&quot;</span>
<span class="f1">-	&quot;github.com/decred/dcrd/mixing&quot;</span>
<span class="f1">-	&quot;github.com/decred/dcrd/mixing/mixclient&quot;</span>
<span class="f1">-	&quot;github.com/decred/dcrd/mixing/mixpool&quot;</span>
<span class="f1">-	&quot;github.com/decred/dcrd/txscript/v4&quot;</span>
<span class="f1">-	&quot;github.com/decred/dcrd/txscript/v4/sign&quot;</span>
<span class="f1">-	&quot;github.com/decred/dcrd/txscript/v4/stdaddr&quot;</span>
<span class="f1">-	&quot;github.com/decred/dcrd/txscript/v4/stdscript&quot;</span>
<span class="f1">-	&quot;github.com/decred/dcrd/wire&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;errors&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;fmt&quot;</span>
<span class="f2">+</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcd/btcec/v2&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcd/btcutil&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcd/chaincfg&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcd/chaincfg/chainhash&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcd/mixing&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcd/mixing/mixclient&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcd/mixing/mixpool&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcd/txscript&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcd/wire&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcwallet/chain&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcwallet/waddrmgr&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcwallet/wallet/txrules&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcwallet/wallet/txsizes&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcwallet/walletdb&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/btcsuite/btcwallet/wtxmgr&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/decred/dcrd/crypto/ripemd160&quot;</span>
<span class="f2">+</span>	<span class="f2">&quot;github.com/decred/go-socks/socks&quot;</span>
 	&quot;golang.org/x/sync/errgroup&quot;
 )
 
<span class="f1">-// MixMessage queries the mixpool for a message.  Only messages that have been
-// recently inv'd should be queried.</span>
<span class="f1">-func (w *Wallet) MixMessage(query *chainhash.Hash) (mixing.Message, error) {</span>
<span class="f1">-	return w.mixpool.Message(query)</span>
<span class="f2">+// Hash160er is an interface that allows the RIPEMD-160 hash to be obtained from
+// addresses that involve them.</span>
<span class="f2">+type Hash160er interface {</span>
<span class="f2">+</span>	<span class="f2">Hash160() *[ripemd160.Size]byte</span>
 }
 
<span class="f1">-type mixpoolBlockchain Wallet</span>
<span class="f1">-</span>
<span class="f1">-func (b *mixpoolBlockchain) CurrentTip() (chainhash.Hash, int64) {</span>
<span class="f1">-	w := (*Wallet)(b)</span>
<span class="f1">-	ctx := context.Background()</span>
<span class="f1">-	hash, height := w.MainChainTip(ctx)</span>
<span class="f1">-	return hash, int64(height)</span>
<span class="f1">-}</span>
<span class="f1">-</span>
<span class="f1">-func (b *mixpoolBlockchain) ChainParams() *chaincfg.Params {</span>
<span class="f1">-	return (*Wallet)(b).chainParams</span>
<span class="f1">-}</span>
<span class="f1">-</span>
<span class="f1">-func (w *Wallet) makeGen(ctx context.Context, account, branch uint32) mixclient.GenFunc {
-	const op errors.Op = &quot;gen&quot;</span>
<span class="f1">-</span>
<span class="f2">+func (w *Wallet) makeGen(account, branch uint32) mixclient.GenFunc {</span>
 	gen := func(mcount uint32) (wire.MixVect, error) {
<span class="f1">-		gen := make(wire.MixVect, mcount)</span>
<span class="f1">-		var updates []func(walletdb.ReadWriteTx) error</span>
<span class="f1">-</span>
<span class="f1">-		for i := uint32(0); i &lt; mcount; i++ {</span>
<span class="f1">-			persist := w.deferPersistReturnedChild(ctx, &amp;updates)</span>
<span class="f1">-			const accountName = &quot;&quot; // not used, so can be faked.</span>
<span class="f1">-			mixAddr, err := w.nextAddress(ctx, op, persist,</span>
<span class="f1">-				accountName, account, branch, WithGapPolicyIgnore())</span>
<span class="f1">-			if err != nil {</span>
<span class="f1">-				return nil, err</span>
<span class="f1">-			}</span>
<span class="f1">-			hash160er, ok := mixAddr.(stdaddr.Hash160er)</span>
<span class="f2">+</span>		<span class="f2">acceptAddress := func(mixAddr waddrmgr.ManagedAddress) bool {</span>
<span class="f2">+</span>			<span class="f2">_, ok := mixAddr.Address().(Hash160er)</span>
 			if !ok {
<span class="f1">-				return nil, errors.E(&quot;address does not have Hash160 method&quot;)</span>
<span class="f2">+</span>				<span class="f2">log.Infof(&quot;address %T does not have hash160 method&quot;, mixAddr)</span>
 			}
<span class="f1">-			gen[i] = *hash160er.Hash160()</span>
<span class="f2">+</span>			<span class="f2">return ok</span>
 		}
 
<span class="f1">-		err := walletdb.Update(ctx, w.db, func(dbtx walletdb.ReadWriteTx) error {</span>
<span class="f1">-			for _, f := range updates {</span>
<span class="f1">-				if err := f(dbtx); err != nil {</span>
<span class="f1">-					return err</span>
<span class="f1">-				}</span>
<span class="f1">-			}</span>
<span class="f1">-			return nil</span>
<span class="f1">-		})</span>
<span class="f2">+</span>		<span class="f2">addresses, err := w.NewAddresses(account, branch, mcount, waddrmgr.KeyScopeBIP0044, acceptAddress)
</span> 		if err != nil {
<span class="f1">-			return nil, errors.E(op, err)</span>
<span class="f2">+</span>			<span class="f2">return nil, err</span>
<span class="f2">+</span>		<span class="f2">}</span>
<span class="f2">+</span>
<span class="f2">+</span>		<span class="f2">gen := make(wire.MixVect, mcount)</span>
<span class="f2">+</span>		<span class="f2">for i := uint32(0); i &lt; mcount; i++ {</span>
<span class="f2">+</span>			<span class="f2">hash160er := addresses[i].(Hash160er)</span>
<span class="f2">+</span>			<span class="f2">gen[i] = *hash160er.Hash160()</span>
 		}
<span class="f2">+</span>
 		return gen, nil
 	}
 	return mixclient.GenFunc(gen)
<span class="f6">@@ -92,8 +67,15 @@</span> type mixingWallet Wallet
 // BestBlock returns the wallet's current best tip block height and hash.
 func (w *mixingWallet) BestBlock() (uint32, chainhash.Hash) {
 	wallet := (*Wallet)(w)
<span class="f1">-	hash, height := wallet.MainChainTip(context.Background())</span>
<span class="f1">-	return uint32(height), hash</span>
<span class="f2">+</span>	<span class="f2">chainClient, err := wallet.requireChainClient()</span>
<span class="f2">+</span>	<span class="f2">if err != nil {</span>
<span class="f2">+</span>		<span class="f2">return 0, chainhash.Hash{}</span>
<span class="f2">+</span>	<span class="f2">}</span>
<span class="f2">+</span>	<span class="f2">hash, height, err := chainClient.GetBestBlock()</span>
<span class="f2">+</span>	<span class="f2">if err != nil {</span>
<span class="f2">+</span>		<span class="f2">return 0, chainhash.Hash{}</span>
<span class="f2">+</span>	<span class="f2">}</span>
<span class="f2">+</span>	<span class="f2">return uint32(height), *hash</span>
 }
 
 // Mixpool returns access to the wallet's mixing message pool.
<span class="f6">@@ -109,121 +91,137 @@</span> func (w *mixingWallet) Mixpool() *mixpool.Pool {
 // SubmitMixMessage submits a mixing message to the wallet's mixpool
 // and broadcasts it to the network.
 func (w *mixingWallet) SubmitMixMessage(ctx context.Context, msg mixing.Message) (err error) {
<span class="f2">+</span>	<span class="f2">wallet := (*Wallet)(w)</span>
<span class="f2">+</span>
<span class="f2">+</span>	<span class="f2">cc, err := wallet.requireChainClient()</span>
<span class="f2">+</span>	<span class="f2">if err != nil {</span>
<span class="f2">+</span>		<span class="f2">return err</span>
<span class="f2">+</span>	<span class="f2">}</span>
<span class="f2">+</span>
<span class="f2">+</span>	<span class="f2">chainClient, ok := cc.(chain.MixingInterface)</span>
<span class="f2">+</span>	<span class="f2">if !ok {</span>
<span class="f2">+</span>		<span class="f2">return fmt.Errorf(&quot;wallet backend does not support mixing&quot;)</span>
<span class="f2">+</span>	<span class="f2">}</span>
<span class="f2">+</span>
 	defer func() {
 		if err != nil {
<span class="f1">-			w.mixpool.RemoveMessage(msg)</span>
<span class="f2">+</span>			<span class="f2">wallet.mixpool.RemoveMessage(msg)</span>
 		}
 	}()
 
<span class="f1">-	_, err = w.mixpool.AcceptMessage(msg)</span>
<span class="f2">+</span>	<span class="f2">_, err = wallet.mixpool.AcceptMessage(msg)</span>
 	if err != nil {
 		return err
 	}
 
<span class="f1">-	w.networkBackendMu.Lock()</span>
<span class="f1">-	n := w.networkBackend</span>
<span class="f1">-	w.networkBackendMu.Unlock()</span>
<span class="f1">-	if n == nil {</span>
<span class="f1">-		return errors.NoPeers</span>
<span class="f1">-	}</span>
<span class="f1">-	return n.PublishMixMessages(ctx, msg)</span>
<span class="f2">+</span>	<span class="f2">return chainClient.PublishMixMessages(msg)</span>
 }
 
 // SignInput adds a signature script to a transaction input.
 func (w *mixingWallet) SignInput(tx *wire.MsgTx, index int, prevScript []byte) error {
 	wallet := (*Wallet)(w)
<span class="f1">-	ctx := context.Background()</span>
 	in := tx.TxIn[index]
 
<span class="f1">-	return walletdb.View(ctx, wallet.db, func(dbtx walletdb.ReadTx) error {</span>
<span class="f1">-		addrmgrNs := dbtx.ReadBucket(waddrmgrNamespaceKey)</span>
<span class="f2">+</span>	<span class="f2">privKey, compressed, privKeyDone, err := wallet.privateKey(prevScript)</span>
<span class="f2">+</span>	<span class="f2">if err != nil {</span>
<span class="f2">+</span>		<span class="f2">return err</span>
<span class="f2">+</span>	<span class="f2">}</span>
 
<span class="f1">-		const scriptVersion = 0</span>
<span class="f1">-		_, addrs := stdscript.ExtractAddrs(scriptVersion, prevScript,</span>
<span class="f1">-			wallet.chainParams)</span>
<span class="f1">-		if len(addrs) != 1 {</span>
<span class="f1">-			return errors.E(errors.Invalid, &quot;previous output is not P2PKH&quot;)</span>
<span class="f1">-		}</span>
<span class="f1">-		apkh, ok := addrs[0].(*stdaddr.AddressPubKeyHashEcdsaSecp256k1V0)</span>
<span class="f1">-		if !ok {</span>
<span class="f1">-			return errors.E(errors.Invalid, &quot;previous output is not P2PKH&quot;)</span>
<span class="f1">-		}</span>
<span class="f1">-		privKey, done, err := wallet.manager.PrivateKey(addrmgrNs, apkh)</span>
<span class="f1">-		if err != nil {</span>
<span class="f1">-			return err</span>
<span class="f1">-		}</span>
<span class="f1">-		defer done()</span>
<span class="f1">-		sigscript, err := sign.SignatureScript(tx, index, prevScript,</span>
<span class="f1">-			txscript.SigHashAll, privKey.Serialize(),</span>
<span class="f1">-			dcrec.STEcdsaSecp256k1, true)</span>
<span class="f1">-		if err != nil {</span>
<span class="f1">-			return errors.E(errors.Op(&quot;sign.SignatureScript&quot;), err)</span>
<span class="f1">-		}</span>
<span class="f1">-		in.SignatureScript = sigscript</span>
<span class="f1">-		return nil</span>
<span class="f1">-	})</span>
<span class="f2">+</span>	<span class="f2">defer privKeyDone()</span>
<span class="f2">+</span>	<span class="f2">sigscript, err := txscript.SignatureScript(tx, index, prevScript,</span>
<span class="f2">+</span>		<span class="f2">txscript.SigHashAll, privKey, compressed)</span>
<span class="f2">+</span>	<span class="f2">if err != nil {</span>
<span class="f2">+</span>		<span class="f2">return fmt.Errorf(&quot;txscript.SignatureScript error: %w&quot;, err)</span>
<span class="f2">+</span>	<span class="f2">}</span>
<span class="f2">+</span>
<span class="f2">+</span>	<span class="f2">in.SignatureScript = sigscript</span>
<span class="f2">+</span>	<span class="f2">return nil</span>
 }
 
 // PublishTransaction adds the transaction to the wallet and publishes
 // it to the network.
 func (w *mixingWallet) PublishTransaction(ctx context.Context, tx *wire.MsgTx) error {
 	wallet := (*Wallet)(w)
<span class="f2">+</span>	<span class="f2">chainClient, err := wallet.requireChainClient()</span>
<span class="f2">+</span>	<span class="f2">if err != nil {</span>
<span class="f2">+</span>		<span class="f2">return err</span>
<span class="f2">+</span>	<span class="f2">}</span>
 
<span class="f1">-	wallet.networkBackendMu.Lock()</span>
<span class="f1">-	n := wallet.networkBackend</span>
<span class="f1">-	wallet.networkBackendMu.Unlock()</span>
<span class="f1">-</span>
<span class="f1">-	_, err := wallet.PublishTransaction(ctx, tx, n)</span>
<span class="f2">+</span>	<span class="f2">_, err = chainClient.SendRawTransaction(tx, true) // TODO: allowHighFees?</span>
 	if err != nil {
 		log.Errorf(&quot;Failed to publish mix transaction: %v&quot;, err)
 	}
 	return err
 }
 
<span class="f1">-func (w *Wallet) dicemixExpiry(ctx context.Context) uint32 {</span>
<span class="f1">-	_, height := w.MainChainTip(ctx)</span>
<span class="f1">-	return mixing.MaxExpiry(uint32(height), w.chainParams) - 2</span>
<span class="f2">+func dicemixExpiry(chainClient chain.Interface, chainParams *chaincfg.Params) (uint32, error) {</span>
<span class="f2">+</span>	<span class="f2">_, height, err := chainClient.GetBestBlock()</span>
<span class="f2">+</span>	<span class="f2">if err != nil {</span>
<span class="f2">+</span>		<span class="f2">return 0, err</span>
<span class="f2">+</span>	<span class="f2">}</span>
<span class="f2">+</span>	<span class="f2">return mixing.MaxExpiry(uint32(height), chainParams) - 2, nil</span>
 }
 
 // addCoinJoinInput adds a wallet's controlled UTXO to the coinjoin
 // transaction.  This method looks up the private key of the previous output
 // to create the UTXO signature proof and requires the wallet or account to be
 // unlocked.
<span class="f1">-func (w *Wallet) addCoinJoinInput(ctx context.Context, cj *mixclient.CoinJoin,</span>
<span class="f1">-	input *wire.TxIn, prevScript []byte, prevScriptVersion uint16) error {</span>
<span class="f2">+func (w *Wallet) addCoinJoinInput(cj *mixclient.CoinJoin,</span>
<span class="f2">+</span>	<span class="f2">input *wire.TxIn, prevScript []byte, prevScriptVersion uint16, value int64) error {</span>
<span class="f2">+</span>	<span class="f2">privKey, _, privKeyDone, err := w.privateKey(prevScript)</span>
<span class="f2">+</span>	<span class="f2">if err != nil {</span>
<span class="f2">+</span>		<span class="f2">return err</span>
<span class="f2">+</span>	<span class="f2">}</span>
<span class="f2">+</span>
<span class="f2">+</span>	<span class="f2">err = cj.AddInput(input, value, prevScript, prevScriptVersion, privKey)</span>
<span class="f2">+</span>	<span class="f2">privKeyDone()</span>
<span class="f2">+</span>	<span class="f2">return err</span>
<span class="f2">+}</span>
 
<span class="f1">-	const scriptVersion = 0</span>
<span class="f1">-	_, addrs := stdscript.ExtractAddrs(scriptVersion, prevScript,</span>
<span class="f1">-		w.chainParams)</span>
<span class="f2">+func (w *Wallet) privateKey(prevScript []byte) (*btcec.PrivateKey, bool, func(), error) {</span>
<span class="f2">+</span>	<span class="f2">_, addrs, _, err := txscript.ExtractPkScriptAddrs(prevScript, w.chainParams)</span>
<span class="f2">+</span>	<span class="f2">if err != nil {</span>
<span class="f2">+</span>		<span class="f2">return nil, false, nil, err</span>
<span class="f2">+</span>	<span class="f2">}</span>
 	if len(addrs) != 1 {
<span class="f1">-		return errors.E(errors.Invalid, &quot;previous output is not P2PKH&quot;)</span>
<span class="f2">+</span>		<span class="f2">return nil, false, nil, fmt.Errorf(&quot;previous output is not P2PKH&quot;)</span>
 	}
<span class="f1">-	prevP2PKH, ok := addrs[0].(*stdaddr.AddressPubKeyHashEcdsaSecp256k1V0)</span>
<span class="f2">+</span>	<span class="f2">prevP2PKH, ok := addrs[0].(*btcutil.AddressPubKeyHash)</span>
 	if !ok {
<span class="f1">-		return errors.E(errors.Invalid, &quot;previous output is not P2PKH&quot;)</span>
<span class="f2">+</span>		<span class="f2">return nil, false, nil, fmt.Errorf(&quot;previous output is not P2PKH&quot;)</span>
 	}
<span class="f1">-	var privKey *secp256k1.PrivateKey</span>
<span class="f1">-	var privKeyDone func()</span>
<span class="f1">-	err := walletdb.View(ctx, w.db, func(dbtx walletdb.ReadTx) error {</span>
<span class="f1">-		addrmgrNs := dbtx.ReadBucket(waddrmgrNamespaceKey)</span>
<span class="f1">-		var err error</span>
<span class="f1">-		privKey, privKeyDone, err = w.manager.PrivateKey(addrmgrNs, prevP2PKH)</span>
<span class="f2">+</span>
<span class="f2">+</span>	<span class="f2">var compressed bool</span>
<span class="f2">+</span>	<span class="f2">var privKey *btcec.PrivateKey</span>
<span class="f2">+</span>	<span class="f2">err = walletdb.View(w.db, func(tx walletdb.ReadTx) error {</span>
<span class="f2">+</span>		<span class="f2">addrmgrNs := tx.ReadBucket(waddrmgrNamespaceKey)</span>
<span class="f2">+</span>		<span class="f2">ma, err := w.Manager.Address(addrmgrNs, prevP2PKH)</span>
<span class="f2">+</span>		<span class="f2">if err != nil {</span>
<span class="f2">+</span>			<span class="f2">return err</span>
<span class="f2">+</span>		<span class="f2">}</span>
<span class="f2">+</span>
<span class="f2">+</span>		<span class="f2">// Only those addresses with keys needed.</span>
<span class="f2">+</span>		<span class="f2">pka, ok := ma.(waddrmgr.ManagedPubKeyAddress)</span>
<span class="f2">+</span>		<span class="f2">if !ok {</span>
<span class="f2">+</span>			<span class="f2">return fmt.Errorf(&quot;no privkey found for address&quot;)</span>
<span class="f2">+</span>		<span class="f2">}</span>
<span class="f2">+</span>
<span class="f2">+</span>		<span class="f2">compressed = pka.Compressed()</span>
<span class="f2">+</span>		<span class="f2">privKey, err = pka.PrivKey()</span>
 		return err
 	})
 	if err != nil {
<span class="f1">-		if privKeyDone != nil {</span>
<span class="f1">-			privKeyDone()</span>
<span class="f2">+</span>		<span class="f2">if privKey != nil {</span>
<span class="f2">+</span>			<span class="f2">privKey.Zero()</span>
 		}
<span class="f1">-		return err</span>
<span class="f2">+</span>		<span class="f2">return nil, false, nil, err</span>
 	}
 
<span class="f1">-	err = cj.AddInput(input, prevScript, prevScriptVersion, privKey)</span>
<span class="f1">-	privKeyDone()</span>
<span class="f1">-	return err</span>
<span class="f2">+</span>	<span class="f2">return privKey, compressed, privKey.Zero, nil</span>
 }
 
 // must be sorted large to small
<span class="f1">-var splitPoints = [...]dcrutil.Amount{</span>
<span class="f2">+var splitPoints = [...]btcutil.Amount{</span>
 	1 &lt;&lt; 36, // 687.19476736
 	1 &lt;&lt; 34, // 171.79869184
 	1 &lt;&lt; 32, // 042.94967296
<span class="f6">@@ -236,11 +234,19 @@</span> var splitPoints = [...]dcrutil.Amount{
 	1 &lt;&lt; 18, // 000.00262144
 }
 
<span class="f1">-func smallestMixChange(feeRate dcrutil.Amount) dcrutil.Amount {</span>
<span class="f2">+func estimateSerializeSizeFromScriptSizes(inputSizes []int, outputSizes []int, changeScriptSize int) int {
+</span>	<span class="f2">outputs := make([]*wire.TxOut, len(outputSizes))</span>
<span class="f2">+</span>	<span class="f2">for i := range outputSizes {</span>
<span class="f2">+</span>		<span class="f2">outputs[i] = wire.NewTxOut(0, make([]byte, outputSizes[i]))</span>
<span class="f2">+</span>	<span class="f2">}</span>
<span class="f2">+</span>	<span class="f2">addChangeOutput := changeScriptSize &gt; 0</span>
<span class="f2">+</span>	<span class="f2">return txsizes.EstimateSerializeSize(len(inputSizes), outputs, addChangeOutput)</span>
<span class="f2">+}</span>
<span class="f2">+</span>
<span class="f2">+func smallestMixChange(feeRate btcutil.Amount) btcutil.Amount {</span>
 	inScriptSizes := []int{txsizes.RedeemP2PKHSigScriptSize}
 	outScriptSizes := []int{txsizes.P2PKHPkScriptSize}
<span class="f1">-	size := txsizes.EstimateSerializeSizeFromScriptSizes(</span>
<span class="f1">-		inScriptSizes, outScriptSizes, 0)</span>
<span class="f2">+</span>	<span class="f2">size := estimateSerializeSizeFromScriptSizes(inScriptSizes, outScriptSizes, 0)</span>
 	fee := txrules.FeeForSerializeSize(feeRate, size)
 	return fee + splitPoints[len(splitPoints)-1]
 }
<span class="f6">@@ -264,89 +270,70 @@</span> var (
 
 // MixOutput performs a mix of a single output into standard sized outputs
 // under the current ticket price.
<span class="f1">-func (w *Wallet) MixOutput(ctx context.Context, output *wire.OutPoint, changeAccount, mixAccount,</span>
<span class="f1">-	mixBranch uint32) error {</span>
<span class="f2">+func (w *Wallet) MixOutput(output *wire.OutPoint, changeAccount, mixAccount, mixBranch uint32,</span>
<span class="f2">+</span>	<span class="f2">feeRate btcutil.Amount) error {</span>
 
<span class="f1">-	op := errors.Opf(&quot;wallet.MixOutput(%v)&quot;, output)</span>
<span class="f2">+</span>	<span class="f2">makeError := func(s string, values ...interface{}) error {</span>
<span class="f2">+</span>		<span class="f2">values = append([]any{output}, values...)</span>
<span class="f2">+</span>		<span class="f2">return fmt.Errorf(&quot;wallet.MixOutput(%v): &quot;+s, values...)</span>
<span class="f2">+</span>	<span class="f2">}</span>
 
 	// Mixing requests require wallet mixing support.
 	if !w.mixingEnabled {
<span class="f1">-		s := &quot;wallet mixing support is disabled&quot;</span>
<span class="f1">-		return errors.E(op, errors.Invalid, s)</span>
<span class="f2">+</span>		<span class="f2">return makeError(&quot;wallet mixing support is disabled&quot;)</span>
 	}
 
<span class="f1">-	nb, err := w.NetworkBackend()</span>
<span class="f2">+</span>	<span class="f2">chainClient, err := w.requireChainClient()</span>
 	if err != nil {
 		return err
 	}
<span class="f1">-	ctx, cancel := WrapNetworkBackendContext(nb, ctx)</span>
<span class="f1">-	defer cancel()</span>
 
<span class="f1">-	sdiff, err := w.NextStakeDifficulty(ctx)</span>
<span class="f1">-	if err != nil {</span>
<span class="f1">-		return errors.E(op, err)</span>
<span class="f1">-	}</span>
<span class="f1">-</span>
<span class="f1">-	w.lockedOutpointMu.Lock()</span>
<span class="f1">-	if _, exists := w.lockedOutpoints[outpoint{output.Hash, output.Index}]; exists {</span>
<span class="f1">-		w.lockedOutpointMu.Unlock()</span>
<span class="f1">-		err = errors.Errorf(&quot;output %v already locked&quot;, output)</span>
<span class="f1">-		return errors.E(op, err)</span>
<span class="f2">+</span>	<span class="f2">w.lockedOutpointsMtx.Lock()</span>
<span class="f2">+</span>	<span class="f2">if _, exists := w.lockedOutpoints[*output]; exists {</span>
<span class="f2">+</span>		<span class="f2">w.lockedOutpointsMtx.Unlock()</span>
<span class="f2">+</span>		<span class="f2">return makeError(&quot;output %v already locked&quot;, output)</span>
 	}
 
 	var prevScript []byte
 	var prevScriptVersion uint16
<span class="f1">-	var amount dcrutil.Amount</span>
<span class="f1">-	err = walletdb.View(ctx, w.db, func(dbtx walletdb.ReadTx) error {</span>
<span class="f2">+</span>	<span class="f2">var amount btcutil.Amount</span>
<span class="f2">+</span>	<span class="f2">err = walletdb.View(w.db, func(dbtx walletdb.ReadTx) error {</span>
 		txmgrNs := dbtx.ReadBucket(wtxmgrNamespaceKey)
<span class="f1">-		txDetails, err := w.txStore.TxDetails(txmgrNs, &amp;output.Hash)</span>
<span class="f2">+</span>		<span class="f2">txDetails, err := w.TxStore.TxDetails(txmgrNs, &amp;output.Hash)</span>
 		if err != nil {
 			return err
 		}
 		out := txDetails.MsgTx.TxOut[output.Index]
 		prevScript = out.PkScript
<span class="f1">-		prevScriptVersion = out.Version</span>
<span class="f1">-		amount = dcrutil.Amount(txDetails.MsgTx.TxOut[output.Index].Value)</span>
<span class="f2">+</span>		<span class="f2">// prevScriptVersion = out.Version</span>
<span class="f2">+</span>		<span class="f2">amount = btcutil.Amount(txDetails.MsgTx.TxOut[output.Index].Value)</span>
 		return nil
 	})
 	if err != nil {
<span class="f1">-		w.lockedOutpointMu.Unlock()</span>
<span class="f1">-		return errors.E(op, err)</span>
<span class="f2">+</span>		<span class="f2">w.lockedOutpointsMtx.Unlock()</span>
<span class="f2">+</span>		<span class="f2">return makeError(&quot;%w&quot;, err)</span>
 	}
<span class="f1">-	w.lockedOutpoints[outpoint{output.Hash, output.Index}] = struct{}{}</span>
<span class="f1">-	w.lockedOutpointMu.Unlock()</span>
<span class="f2">+</span>	<span class="f2">w.lockedOutpoints[*output] = struct{}{}</span>
<span class="f2">+</span>	<span class="f2">w.lockedOutpointsMtx.Unlock()</span>
 
 	defer func() {
<span class="f1">-		w.lockedOutpointMu.Lock()</span>
<span class="f1">-		delete(w.lockedOutpoints, outpoint{output.Hash, output.Index})</span>
<span class="f1">-		w.lockedOutpointMu.Unlock()</span>
<span class="f2">+</span>		<span class="f2">w.lockedOutpointsMtx.Lock()</span>
<span class="f2">+</span>		<span class="f2">delete(w.lockedOutpoints, *output)</span>
<span class="f2">+</span>		<span class="f2">w.lockedOutpointsMtx.Unlock()</span>
 	}()
 
 	var i int
 	var count uint32
<span class="f1">-	var mixValue, remValue, changeValue dcrutil.Amount</span>
<span class="f1">-	var feeRate = w.RelayFee()</span>
<span class="f2">+</span>	<span class="f2">var mixValue, remValue, changeValue btcutil.Amount</span>
 	var smallestMixChange = smallestMixChange(feeRate)
 SplitPoints:
 	for i = 0; i &lt; len(splitPoints); i++ {
 		last := i == len(splitPoints)-1
 		mixValue = splitPoints[i]
 
<span class="f1">-		// When the sdiff is more than this mixed output amount, there</span>
<span class="f1">-		// is a smaller common mixed amount with more pairing activity</span>
<span class="f1">-		// (due to CoinShuffle++ participation from ticket buyers).</span>
<span class="f1">-		// Skipping this amount and moving to the next smallest common</span>
<span class="f1">-		// mixed amount will result in quicker pairings, or pairings</span>
<span class="f1">-		// occurring at all.  The number of mixed outputs is capped to</span>
<span class="f1">-		// prevent a single mix being overwhelmingly funded by a single</span>
<span class="f1">-		// output, and to conserve memory resources.</span>
<span class="f1">-		if !last &amp;&amp; mixValue &gt;= sdiff {</span>
<span class="f1">-			continue</span>
<span class="f1">-		}</span>
<span class="f1">-</span>
 		count = min(uint32(amount/mixValue), 4)
 		for ; count &gt; 0; count-- {
<span class="f1">-			remValue = amount - dcrutil.Amount(count)*mixValue</span>
<span class="f2">+</span>			<span class="f2">remValue = amount - btcutil.Amount(count)*mixValue</span>
 			if remValue &lt; 0 {
 				continue
 			}
<span class="f6">@@ -360,7 +347,7 @@</span> SplitPoints:
 			for i := range outScriptSizes {
 				outScriptSizes[i] = P2PKHv0Len
 			}
<span class="f1">-			size := txsizes.EstimateSerializeSizeFromScriptSizes(</span>
<span class="f2">+</span>			<span class="f2">size := estimateSerializeSizeFromScriptSizes(</span>
 				inScriptSizes, outScriptSizes, P2PKHv0Len)
 			fee := txrules.FeeForSerializeSize(feeRate, size)
 			changeValue = remValue - fee
<span class="f6">@@ -371,7 +358,7 @@</span> SplitPoints:
 				// Determine required fee without a change
 				// output.  A lower mix count or amount is
 				// required if the fee is still not payable.
<span class="f1">-				size = txsizes.EstimateSerializeSizeFromScriptSizes(</span>
<span class="f2">+</span>				<span class="f2">size = estimateSerializeSizeFromScriptSizes(</span>
 					inScriptSizes, outScriptSizes, 0)
 				fee = txrules.FeeForSerializeSize(feeRate, size)
 				if remValue &lt; fee {
<span class="f6">@@ -387,12 +374,11 @@</span> SplitPoints:
 		}
 	}
 	if i == len(splitPoints) {
<span class="f1">-		err := errors.Errorf(&quot;output %v (%v): %w&quot;, output, amount, errNoSplitDenomination)</span>
<span class="f1">-		return errors.E(op, err)</span>
<span class="f2">+</span>		<span class="f2">return makeError(&quot;output %v (%v): %w&quot;, output, amount, errNoSplitDenomination)</span>
 	}
 	select {
<span class="f1">-	case &lt;-ctx.Done():</span>
<span class="f1">-		return errors.E(op, ctx.Err())</span>
<span class="f2">+</span>	<span class="f2">case &lt;-w.quitChan():</span>
<span class="f2">+</span>		<span class="f2">return fmt.Errorf(&quot;wallet is shutting down or has shut down&quot;)</span>
 	case w.mixSems.splitSems[i] &lt;- struct{}{}:
 		defer func() { &lt;-w.mixSems.splitSems[i] }()
 	default:
<span class="f6">@@ -401,38 +387,41 @@</span> SplitPoints:
 
 	var change *wire.TxOut
 	if changeValue &gt; 0 {
<span class="f1">-		persist := w.persistReturnedChild(ctx, nil)</span>
<span class="f1">-		const accountName = &quot;&quot; // not used, so can be faked.</span>
<span class="f1">-		addr, err := w.nextAddress(ctx, op, persist,</span>
<span class="f1">-			accountName, changeAccount, udb.InternalBranch, WithGapPolicyIgnore())</span>
<span class="f2">+</span>		<span class="f2">addr, err := w.NewChangeAddress(changeAccount, waddrmgr.KeyScopeBIP0044)</span>
<span class="f2">+</span>		<span class="f2">if err != nil {</span>
<span class="f2">+</span>			<span class="f2">return makeError(&quot;%w&quot;, err)</span>
<span class="f2">+</span>		<span class="f2">}</span>
<span class="f2">+</span>
<span class="f2">+</span>		<span class="f2">changeScript, err := txscript.PayToAddrScript(addr)</span>
 		if err != nil {
<span class="f1">-			return errors.E(op, err)</span>
<span class="f2">+</span>			<span class="f2">return makeError(&quot;change address error: %w&quot;, err)</span>
 		}
<span class="f1">-		version, changeScript := addr.PaymentScript()</span>
<span class="f2">+</span>
 		change = &amp;wire.TxOut{
 			Value:    int64(changeValue),
 			PkScript: changeScript,
<span class="f1">-			Version:  version,</span>
<span class="f2">+</span>			<span class="f2">// Version:  version,</span>
 		}
 	}
 
 	log.Infof(&quot;Mixing output %v (%v)&quot;, output, amount)
 
<span class="f1">-	gen := w.makeGen(ctx, mixAccount, mixBranch)</span>
<span class="f1">-	expires := w.dicemixExpiry(ctx)</span>
<span class="f1">-	cj := mixclient.NewCoinJoin(gen, change, int64(mixValue), expires, count)</span>
<span class="f1">-	input := &amp;wire.TxIn{</span>
<span class="f1">-		PreviousOutPoint: *output,</span>
<span class="f1">-		ValueIn:          int64(amount),</span>
<span class="f2">+</span>	<span class="f2">expires, err := dicemixExpiry(chainClient, w.chainParams)</span>
<span class="f2">+</span>	<span class="f2">if err != nil {</span>
<span class="f2">+</span>		<span class="f2">return makeError(&quot;dicemixExpiry error: %w&quot;, err)</span>
 	}
<span class="f1">-	err = w.addCoinJoinInput(ctx, cj, input, prevScript, prevScriptVersion)</span>
<span class="f2">+</span>
<span class="f2">+</span>	<span class="f2">gen := w.makeGen(mixAccount, mixBranch)</span>
<span class="f2">+</span>	<span class="f2">cj := mixclient.NewCoinJoin(gen, change, int64(mixValue), expires, count)</span>
<span class="f2">+</span>	<span class="f2">input := wire.NewTxIn(output, nil, nil)</span>
<span class="f2">+</span>	<span class="f2">err = w.addCoinJoinInput(cj, input, prevScript, prevScriptVersion, int64(amount))</span>
 	if err != nil {
<span class="f1">-		return errors.E(op, err)</span>
<span class="f2">+</span>		<span class="f2">return makeError(&quot;addCoinJoinInput error: %w&quot;, err)</span>
 	}
 
<span class="f1">-	err = w.mixClient.Dicemix(ctx, cj)</span>
<span class="f2">+</span>	<span class="f2">err = w.mixClient.Dicemix(w.mixCtx, cj)</span>
 	if err != nil {
<span class="f1">-		return errors.E(op, err)</span>
<span class="f2">+</span>		<span class="f2">return makeError(&quot;mixClient.Dicemix error: %w&quot;, err)</span>
 	}
 
 	tx := cj.Tx()
<span class="f6">@@ -446,118 +435,99 @@</span> SplitPoints:
 //
 // Due to performance concerns of timing out in a CoinShuffle++ run, this
 // function may throttle how many of the outputs are mixed each call.
<span class="f1">-func (w *Wallet) MixAccount(ctx context.Context, changeAccount, mixAccount,</span>
<span class="f1">-	mixBranch uint32) error {</span>
<span class="f1">-	const op errors.Op = &quot;wallet.MixAccount&quot;</span>
<span class="f1">-</span>
<span class="f2">+func (w *Wallet) MixAccount(changeAccount, mixAccount, mixBranch uint32, feeRate btcutil.Amount) error {</span>
 	// Mixing requests require wallet mixing support.
 	if !w.mixingEnabled {
<span class="f1">-		s := &quot;wallet mixing support is disabled&quot;</span>
<span class="f1">-		return errors.E(op, errors.Invalid, s)</span>
<span class="f2">+</span>		<span class="f2">return fmt.Errorf(&quot;wallet.MixAccount: wallet mixing support is disabled&quot;)</span>
 	}
 
<span class="f1">-	_, tipHeight := w.MainChainTip(ctx)</span>
<span class="f1">-	w.lockedOutpointMu.Lock()</span>
<span class="f1">-	var credits []Input</span>
<span class="f1">-	err := walletdb.View(ctx, w.db, func(dbtx walletdb.ReadTx) error {</span>
<span class="f1">-		var err error</span>
<span class="f1">-		const minconf = 2</span>
<span class="f1">-		const targetAmount = 0</span>
<span class="f2">+</span>	<span class="f2">chainClient, err := w.requireChainClient()</span>
<span class="f2">+</span>	<span class="f2">if err != nil {</span>
<span class="f2">+</span>		<span class="f2">return err</span>
<span class="f2">+</span>	<span class="f2">}</span>
<span class="f2">+</span>
<span class="f2">+</span>	<span class="f2">// Get current block's height and hash.</span>
<span class="f2">+</span>	<span class="f2">bs, err := chainClient.BlockStamp()</span>
<span class="f2">+</span>	<span class="f2">if err != nil {</span>
<span class="f2">+</span>		<span class="f2">return err</span>
<span class="f2">+</span>	<span class="f2">}</span>
<span class="f2">+</span>
<span class="f2">+</span>	<span class="f2">var credits []wtxmgr.Credit</span>
<span class="f2">+</span>	<span class="f2">err = walletdb.View(w.db, func(dbtx walletdb.ReadTx) error {</span>
 		var minAmount = splitPoints[len(splitPoints)-1]
 		var maxResults = cap(w.mixSems.splitSems[0]) * len(splitPoints)
<span class="f1">-		credits, err = w.findEligibleOutputsAmount(dbtx, changeAccount, minconf,</span>
<span class="f1">-			targetAmount, tipHeight, minAmount, maxResults)</span>
<span class="f2">+</span>		<span class="f2">var foundUtxosCount int</span>
<span class="f2">+</span>		<span class="f2">allowUtxo := func(utxo wtxmgr.Credit) bool {</span>
<span class="f2">+</span>			<span class="f2">if utxo.Amount &lt; minAmount {</span>
<span class="f2">+</span>				<span class="f2">return false</span>
<span class="f2">+</span>			<span class="f2">}</span>
<span class="f2">+</span>			<span class="f2">if foundUtxosCount+1 &gt;= maxResults {</span>
<span class="f2">+</span>				<span class="f2">return false</span>
<span class="f2">+</span>			<span class="f2">}</span>
<span class="f2">+</span>			<span class="f2">return true</span>
<span class="f2">+</span>		<span class="f2">}</span>
<span class="f2">+</span>
<span class="f2">+</span>		<span class="f2">var err error</span>
<span class="f2">+</span>		<span class="f2">const minconf = 2</span>
<span class="f2">+</span>		<span class="f2">credits, err = w.findEligibleOutputs(dbtx, &amp;waddrmgr.KeyScopeBIP0044, changeAccount, minconf,</span>
<span class="f2">+</span>			<span class="f2">bs, allowUtxo)</span>
 		return err
 	})
 	if err != nil {
<span class="f1">-		w.lockedOutpointMu.Unlock()</span>
<span class="f1">-		return errors.E(op, err)</span>
<span class="f2">+</span>		<span class="f2">return fmt.Errorf(&quot;wallet.MixAccount: %w&quot;, err)</span>
 	}
<span class="f1">-	w.lockedOutpointMu.Unlock()</span>
 
 	var g errgroup.Group
<span class="f1">-	var success atomic.Int32</span>
 	for i := range credits {
 		op := &amp;credits[i].OutPoint
 		g.Go(func() error {
<span class="f1">-			err := w.MixOutput(ctx, op, changeAccount, mixAccount, mixBranch)</span>
<span class="f1">-			if err == nil {</span>
<span class="f1">-				success.Add(1)</span>
<span class="f2">+</span>			<span class="f2">err := w.MixOutput(op, changeAccount, mixAccount, mixBranch, feeRate)</span>
<span class="f2">+</span>			<span class="f2">if errors.Is(err, errThrottledMixRequest) {</span>
<span class="f2">+</span>				<span class="f2">return nil</span>
<span class="f2">+</span>			<span class="f2">}</span>
<span class="f2">+</span>			<span class="f2">if errors.Is(err, errNoSplitDenomination) {</span>
<span class="f2">+</span>				<span class="f2">return nil</span>
 			}
<span class="f1">-			switch {</span>
<span class="f1">-			case errors.Is(err, errNoSplitDenomination):</span>
<span class="f1">-				log.Debugf(&quot;Unable to mix output for account %q: %v&quot;,</span>
<span class="f1">-					changeAccount, err)</span>
<span class="f1">-				err = nil</span>
<span class="f1">-			case errors.Is(err, errThrottledMixRequest):</span>
<span class="f1">-				log.Debugf(&quot;Temporarily skipped output %v during account %q mix: %v&quot;,</span>
<span class="f1">-					op, changeAccount, err)</span>
<span class="f1">-				err = nil</span>
<span class="f2">+</span>			<span class="f2">if errors.Is(err, socks.ErrPoolMaxConnections) {</span>
<span class="f2">+</span>				<span class="f2">return nil</span>
 			}
 			return err
 		})
 	}
 	err = g.Wait()
<span class="f1">-	log.Debugf(&quot;Mixed %d of %d selected outputs of account %q&quot;, success.Load(),</span>
<span class="f1">-		len(credits), changeAccount)</span>
 	if err != nil {
<span class="f1">-		return errors.E(op, err)</span>
<span class="f2">+</span>		<span class="f2">return fmt.Errorf(&quot;wallet.MixAccount: %w&quot;, err)</span>
 	}
 	return nil
 }
 
<span class="f1">-// PossibleCoinJoin tests if a transaction may be a CSPP-mixed transaction.</span>
<span class="f1">-// It can return false positives, as one can create a tx which looks like a</span>
<span class="f1">-// coinjoin tx, although it isn't.</span>
<span class="f1">-func PossibleCoinJoin(tx *wire.MsgTx) (isMix bool, mixDenom int64, mixCount uint32) {</span>
<span class="f1">-	if len(tx.TxOut) &lt; 3 || len(tx.TxIn) &lt; 3 {</span>
<span class="f1">-		return false, 0, 0</span>
<span class="f1">-	}</span>
<span class="f1">-</span>
<span class="f1">-	numberOfOutputs := len(tx.TxOut)</span>
<span class="f1">-	numberOfInputs := len(tx.TxIn)</span>
<span class="f2">+func (w *Wallet) StartAutoMixer(changeAccount, mixAccount, mixBranch uint32, feeRate btcutil.Amount) error {
+</span>	<span class="f2">c := w.NtfnServer.TransactionNotifications()</span>
<span class="f2">+</span>	<span class="f2">defer c.Done()</span>
 
<span class="f1">-	mixedOuts := make(map[int64]uint32)</span>
<span class="f1">-	scripts := make(map[string]int)</span>
<span class="f1">-	for _, o := range tx.TxOut {</span>
<span class="f1">-		scripts[string(o.PkScript)]++</span>
<span class="f1">-		if scripts[string(o.PkScript)] &gt; 1 {</span>
<span class="f1">-			return false, 0, 0</span>
<span class="f1">-		}</span>
<span class="f1">-		val := o.Value</span>
<span class="f1">-		// Multiple zero valued outputs do not count as a coinjoin mix.</span>
<span class="f1">-		if val == 0 {</span>
<span class="f1">-			continue</span>
<span class="f1">-		}</span>
<span class="f1">-		mixedOuts[val]++</span>
<span class="f1">-	}</span>
<span class="f2">+</span>	<span class="f2">for {</span>
<span class="f2">+</span>		<span class="f2">select {</span>
<span class="f2">+</span>		<span class="f2">case &lt;-w.quitChan():</span>
<span class="f2">+</span>			<span class="f2">return fmt.Errorf(&quot;wallet is shutting down or has shut down&quot;)</span>
<span class="f2">+</span>		<span class="f2">case n := &lt;-c.C:</span>
<span class="f2">+</span>			<span class="f2">if len(n.AttachedBlocks) == 0 {</span>
<span class="f2">+</span>				<span class="f2">continue</span>
<span class="f2">+</span>			<span class="f2">}</span>
 
<span class="f1">-	for val, count := range mixedOuts {</span>
<span class="f1">-		if count &lt; 3 {</span>
<span class="f1">-			continue</span>
<span class="f1">-		}</span>
<span class="f1">-		if val &gt; mixDenom {</span>
<span class="f1">-			mixDenom = val</span>
<span class="f1">-			mixCount = count</span>
<span class="f1">-		}</span>
<span class="f2">+</span>			<span class="f2">// Don't perform any actions while transactions are not synced through</span>
<span class="f2">+</span>			<span class="f2">// the tip block.</span>
<span class="f2">+</span>			<span class="f2">// TODO: w.ChainSynced() isn't really reliable.</span>
<span class="f2">+</span>			<span class="f2">if !w.ChainSynced() {</span>
<span class="f2">+</span>				<span class="f2">log.Debugf(&quot;Skipping automixer actions: transactions are not synced&quot;)</span>
<span class="f2">+</span>				<span class="f2">continue</span>
<span class="f2">+</span>			<span class="f2">}</span>
 
<span class="f1">-		outputsWithNotSameAmount := uint32(numberOfOutputs) - count</span>
<span class="f1">-		if outputsWithNotSameAmount &gt; uint32(numberOfInputs) {</span>
<span class="f1">-			return false, 0, 0</span>
<span class="f2">+</span>			<span class="f2">go func() {</span>
<span class="f2">+</span>				<span class="f2">err := w.MixAccount(changeAccount, mixAccount, mixBranch, feeRate)</span>
<span class="f2">+</span>				<span class="f2">if err != nil {</span>
<span class="f2">+</span>					<span class="f2">log.Error(err)</span>
<span class="f2">+</span>				<span class="f2">}</span>
<span class="f2">+</span>			<span class="f2">}()</span>
 		}
 	}
<span class="f1">-</span>
<span class="f1">-	isMix = mixCount &gt;= uint32(len(tx.TxOut)/2)</span>
<span class="f1">-	return</span>
<span class="f1">-}</span>
<span class="f1">-</span>
<span class="f1">-// AcceptMixMessage adds a mixing message received from the network backend to</span>
<span class="f1">-// the wallet's mixpool.</span>
<span class="f1">-func (w *Wallet) AcceptMixMessage(msg mixing.Message) error {</span>
<span class="f1">-	_, err := w.mixpool.AcceptMessage(msg)</span>
<span class="f1">-	if err != nil {</span>
<span class="f1">-		return err</span>
<span class="f1">-	}</span>
<span class="f1">-</span>
<span class="f1">-	return nil</span>
 }
</pre>
</body>
</html>
